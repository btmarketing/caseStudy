////////////////////////////////////////
////////////////////////////////////////
////////////////////////////////////////

var grips_data = [
	{
		month:2,
		day:20,
		value:9828
	},
	{
		month:2,
		day:21,
		value:8844
	},
	{
		month:2,
		day:22,
		value:11578
	},
	{
		month:2,
		day:23,
		value:8015
	},
	{
		month:2,
		day:24,
		value:5616
	},
	{
		month:2,
		day:25,
		value:7770
	},
	{
		month:2,
		day:26,
		value:8228
	},
	{
		month:2,
		day:27,
		value:17481
	},
	{
		month:2,
		day:28,
		value:17713
	},
	{
		month:2,
		day:29,
		value:12604
	},
	{
		month:3,
		day:01,
		value:13518
	},
	{
		month:3,
		day:02,
		value:10994
	},
	{
		month:3,
		day:03,
		value:18379
	},
	{
		month:3,
		day:04,
		value:13013
	},
	{
		month:3,
		day:05,
		value:9545
	},
	{
		month:3,
		day:06,
		value:7978
	},
	{
		month:3,
		day:07,
		value:10481
	},
	{
		month:3,
		day:08,
		value:25499
	},
	{
		month:3,
		day:09,
		value:13607
	},
	{
		month:3,
		day:10,
		value:13068
	},
	{
		month:3,
		day:11,
		value:10713
	},
	{
		month:3,
		day:12,
		value:11618
	},
	{
		month:3,
		day:13,
		value:17527
	},
	{
		month:3,
		day:14,
		value:17536
	},
	{
		month:3,
		day:15,
		value:16541
	},
	{
		month:3,
		day:16,
		value:17255
	},
	{
		month:3,
		day:17,
		value:15157
	},
	{
		month:3,
		day:18,
		value:12968
	},
	{
		month:3,
		day:19,
		value:15375
	},
	{
		month:3,
		day:20,
		value:10162
	},
	{
		month:3,
		day:21,
		value:11994
	},
	{
		month:3,
		day:22,
		value:18230
	},
	{
		month:3,
		day:23,
		value:8448
	},
	{
		month:3,
		day:24,
		value:11929
	},
	{
		month:3,
		day:25,
		value:9095
	},
	{
		month:3,
		day:26,
		value:13178
	},
	{
		month:3,
		day:27,
		value:18504
	},
	{
		month:3,
		day:28,
		value:29907
	},
	{
		month:3,
		day:29,
		value:17304
	},
	{
		month:3,
		day:30,
		value:18053
	},
	{
		month:3,
		day:31,
		value:17107
	},
	{
		month:4,
		day:01,
		value:11026
	},
	{
		month:4,
		day:02,
		value:15965
	},
	{
		month:4,
		day:03,
		value:14875
	},
	{
		month:4,
		day:04,
		value:26314
	},
	{
		month:4,
		day:05,
		value:13036
	},
	{
		month:4,
		day:06,
		value:16785
	},
	{
		month:4,
		day:07,
		value:16410
	},
	{
		month:4,
		day:08,
		value:11683
	},
	{
		month:4,
		day:09,
		value:11778
	},
	{
		month:4,
		day:10,
		value:27045
	},
	{
		month:4,
		day:11,
		value:14459
	},
	{
		month:4,
		day:12,
		value:12771
	},
	{
		month:4,
		day:13,
		value:35804
	},
	{
		month:4,
		day:14,
		value:30460
	},
	{
		month:4,
		day:15,
		value:88005
	},
	{
		month:4,
		day:16,
		value:96777
	},
	{
		month:4,
		day:17,
		value:69680
	},
	{
		month:4,
		day:18,
		value:82872
	},
	{
		month:4,
		day:19,
		value:68388
	},
	{
		month:4,
		day:20,
		value:84226
	},
	{
		month:4,
		day:21,
		value:82047
	},
	{
		month:4,
		day:22,
		value:78150
	},
	{
		month:4,
		day:23,
		value:90451
	},
	{
		month:4,
		day:24,
		value:104160
	},
	{
		month:4,
		day:25,
		value:95818
	},
	{
		month:4,
		day:26,
		value:83626
	},
	{
		month:4,
		day:27,
		value:83280
	},
	{
		month:4,
		day:28,
		value:75734
	},
	{
		month:4,
		day:29,
		value:55687
	},
	{
		month:4,
		day:30,
		value:58471
	},
	{
		month:5,
		day:01,
		value:45948
	},
	{
		month:5,
		day:02,
		value:69953
	},
	{
		month:5,
		day:03,
		value:74750
	},
	{
		month:5,
		day:04,
		value:51709
	},
	{
		month:5,
		day:05,
		value:50297
	},
	{
		month:5,
		day:06,
		value:50221
	},
	{
		month:5,
		day:08,
		value:43213
	},
	{
		month:5,
		day:09,
		value:39230
	},
	{
		month:5,
		day:10,
		value:44829
	},
	{
		month:5,
		day:11,
		value:40393
	},
	{
		month:5,
		day:12,
		value:39086
	},
	{
		month:5,
		day:13,
		value:30521
	},
	{
		month:5,
		day:14,
		value:28776
	},
	{
		month:5,
		day:15,
		value:31663
	},
	{
		month:5,
		day:16,
		value:48594
	},
	{
		month:5,
		day:17,
		value:41220
	},
	{
		month:5,
		day:18,
		value:36669
	}
];

var grips_coordLine_data = [-.23,-.46,-.91,.23,.46,.91];

////////////////////////////////////////
////////////////////////////////////////
////////////////////////////////////////

var grips_w = unitSize*4-gutter*2-40;
var grips_h = unitSize*2-gutter-40;

var grips_animating = true;

var grips_divider = 1400; 	

var gripsViz = d3.select('#gripsGraph_div').append('svg')
	.attr('id','gripsSVG')
	.attr('width',grips_w)
	.attr('height',grips_h);

var deathGrips_fadeIn_time = 5000;

var gripsSVG = document.getElementById('gripsSVG');
gripsSVG.style.position = 'absolute';
gripsSVG.style.left = '20px';
gripsSVG.style.top = '20px';

var grips_easingType = 'back';
var grips_easingTime = 500;
var grips_indexOffset = 0;

////////////////////////////////////////
////////////////////////////////////////
////////////////////////////////////////

var gripsDisplay = false;

setInterval(function(){
    if(document.getElementById('gripsSVG').offsetWidth){
        if(!gripsDisplay){
            gripsDisplay=true;
            startGrips();
        }
    }
    else if (gripsDisplay){
        gripsDisplay=false;
        endGrips();
    }
},500);

////////////////////////////////////////
////////////////////////////////////////
////////////////////////////////////////

function endGrips(){
	grips_animating = false;
	cancelAllTransitions();
	gripsViz.selectAll('.grips_line')
		.attr('y1',grips_h/2)
		.attr('y2',grips_h/2);
}

function startGrips(){
	grips_animating = true;
	initGripsGraph();
}

////////////////////////////////////////
////////////////////////////////////////
////////////////////////////////////////

function cancelAllTransitions(){
	gripsViz.selectAll('line').each(function() {
		var lock = this.__transition__;
		if (lock) lock.active = 0;
	});
}

////////////////////////////////////////
////////////////////////////////////////
////////////////////////////////////////

function initGripsGraph(){

	cancelAllTransitions();

	gripsViz.selectAll('line.grips_coordLine')
		.data(grips_coordLine_data)
		.enter()
			.append('line')
			.attr('class','grips_coordLine')
			.attr('stroke','white')
			.attr('x1',40)
			.attr('x2',grips_w)
			.attr('y1',function(d){
				return ((grips_h/2)*d)+grips_h/2;
			})
			.attr('y2',function(d){
				return ((grips_h/2)*d)+grips_h/2;
			})
			.attr('stroke-width',1)
			.attr('opacity',0);

	gripsViz.selectAll('text.grips_coordLine_data')
		.data(grips_coordLine_data)
		.enter()
			.append('text')
			.attr('class','grips_coordLine_data')
			.attr('text-anchor','left')
			.attr('x',0)
			.attr('fontSize',20)
			.attr('fill','white')
			.attr('y',function(d){
				if(d>0){
					return ((grips_h/2)*d)+grips_h/2+6;
				}
				else{
					return ((grips_h/2)*d)+grips_h/2+6;
				}
			})
			.text(function(d){
				var val = Math.abs(d)*(grips_h/2)*grips_divider;
				return Math.floor(val/1000)+'k';
			})
			.attr('opacity',0);

	gripsViz.selectAll('line.grips_line')
		.data(grips_data)
		.enter()
			.append('line')
			.attr('class','grips_line')
			.attr('id',function(d,i){
				return 'grips_line_'+i;
			})
			.attr('stroke','rgb(150,136,194)')
			.attr('x1',function(d,i){
				if(i>0){
					return (grips_w/grips_data.length)*(i-1);
				}
				else{
					return 0;
				}
			})
			.attr('y1',function(){
				return grips_h/2;
			})
			.attr('x2',function(d,i){
				return (grips_w/grips_data.length)*i;
			})
			.attr('y2',function(){
				return grips_h/2;
			})
			.attr('stroke-width',3);

	gripsViz.selectAll('line.grips_btJoin')
		.data([Math.floor(grips_data.length*.61)])
		.enter()
			.append('line')
			.attr('id','grips_btJoinLine')
			.attr('class','grips_btJoin')
			.attr('stroke','red')
			.attr('stroke-width',3)
			.attr('opacity',.3)
			.attr('x1',function(d){
				return (grips_w/grips_data.length)*d;
			})
			.attr('x2',function(d){
				return (grips_w/grips_data.length)*d;
			})
			.attr('y1',grips_h/2)
			.attr('y2',grips_h/2);

	gripsViz.selectAll('rect')
		.data([0])
		.enter()
			.append('rect')
			.attr('x',0)
			.attr('y',0)
			.attr('width',grips_w)
			.attr('height',grips_h)
			.attr('opacity',.8)
			.attr('fill','rgb(90,76,134)')
			.on('mouseover',function(){
				if(grips_animating){
					grips_animating = false;
					cancelAllTransitions();
					for(var n=0;n<grips_data.length;n++){
						grips_goUp(grips_data[n],n,1,false);
					}
					gripsViz.selectAll('rect')
						.transition()
						.duration(500)
						.attr('opacity',0);
					gripsViz.selectAll('line.grips_coordLine')
						.transition()
						.duration(1000)
						.attr('opacity',.2);
					gripsViz.selectAll('text.grips_coordLine_data')
						.transition()
						.duration(1000)
						.attr('opacity',.2);
					gripsViz.select('#grips_btJoinLine')
						.transition()
						.duration(1000)
						.attr('y2',grips_h)
						.attr('y1',0);
				}
			})
			.on('mouseout',function(){
				if(!grips_animating){
					grips_animating = true;
					for(var n=0;n<grips_data.length;n++){
						grips_goDown(grips_data[n],n,1,true,true);
					}
					gripsViz.selectAll('rect')
						.transition()
						.duration(1000)
						.attr('opacity',.8);
					gripsViz.selectAll('line.grips_coordLine')
						.transition()
						.duration(500)
						.attr('opacity',0);
					gripsViz.selectAll('text.grips_coordLine_data')
						.transition()
						.duration(1000)
						.attr('opacity',0);
					gripsViz.select('#grips_btJoinLine')
						.transition()
						.duration(100)
						.attr('y2',grips_h/2)
						.attr('y1',grips_h/2);
				}
			});

	for(var n=0;n<grips_data.length;n++){
		grips_goDown(grips_data[n],n,1,true,true);
	}
}

////////////////////////////////////////
////////////////////////////////////////
////////////////////////////////////////

function grips_goDown(data,index,dir,delay){
	if(index===grips_data.length-1){
		grips_indexOffset = 0;
	}
	gripsViz.select('#grips_line_'+index)
		.transition()
		.duration(grips_easingTime)
		.delay(function(){
			var tempIndex = index;
			if(delay){
				return tempIndex*(grips_easingTime/(grips_data.length*.5));
			}
			else{
				return 0;
			}
		})
		.ease(grips_easingType)
		.attr('y2',function(){
			return grips_h/2;
		})
		.attr('y1',function(){
			return grips_h/2;
		})
		.each('end',(function(d,i){
			var tempData = data;
			var tempIndex = index;
			var tempDir = dir;
			return function(){
				grips_goUp(tempData,tempIndex,tempDir*1,true);
			}
		})());
}

function grips_goUp(data,index,dir,loop){
	gripsViz.select('#grips_line_'+index)
		.transition()
		.duration(function(){
			if(loop){
				return grips_easingTime;
			}
			else{
				return 200;
			}
		})
		.ease(grips_easingType)
		.attr('y2',function(d,i){
			var tempLookup = (index+grips_indexOffset)%grips_data.length;
			if(tempLookup<grips_data.length-1){
				if(tempLookup%2===0){
					return grips_h/2-((grips_data[tempLookup].value/grips_divider)*dir);
				}
				else{
					return grips_h/2+((grips_data[tempLookup].value/grips_divider)*dir);
				}
			}
			else{
				return grips_h/2;
			}
		})
		.attr('y1',function(d,i){
			var tempLookup = (index+grips_indexOffset)%grips_data.length;
			if(tempLookup>0){
				if(tempLookup%2===0){
					return grips_h/2+((grips_data[tempLookup-1].value/grips_divider)*dir);
				}
				else{
					return grips_h/2-((grips_data[tempLookup-1].value/grips_divider)*dir);
				}
			}
			else{
				return grips_h/2;
			}
		})
		.each('end',(function(){
			var tempData = data;
			var tempIndex = index;
			var tempDir = dir;
			if(loop && grips_animating){
				return function(){
					grips_goDown(tempData,tempIndex,dir);
				}
			}
		})());
}

////////////////////////////////////////
////////////////////////////////////////
////////////////////////////////////////